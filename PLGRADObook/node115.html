<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<!--Converted with LaTeX2HTML 2008 (1.71)
original version by:  Nikos Drakos, CBLU, University of Leeds
* revised and updated by:  Marcus Hennecke, Ross Moore, Herb Swan
* with significant contributions from:
  Jens Lippmann, Marek Rouchal, Martin Wilck and others -->
<HTML>
<HEAD>
<TITLE>Middleware y la Clase Rack::Builder</TITLE>
<META NAME="description" CONTENT="Middleware y la Clase Rack::Builder">
<META NAME="keywords" CONTENT="javascriptexamples">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">

<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="Generator" CONTENT="LaTeX2HTML v2008">
<META HTTP-EQUIV="Content-Style-Type" CONTENT="text/css">

<LINK REL="STYLESHEET" HREF="mystyle.css">

<LINK REL="next" HREF="node116.html">
<LINK REL="previous" HREF="node114.html">
<LINK REL="up" HREF="node97.html">
<LINK REL="next" HREF="node116.html">
</HEAD>

<BODY >

<DIV CLASS="navigation">
<A NAME="tex2html4647"
  HREF="node116.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A> 
<A NAME="tex2html4641"
  HREF="node97.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A> 
<A NAME="tex2html4635"
  HREF="node114.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A> 
<A NAME="tex2html4643"
  HREF="node221.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A> 
<A NAME="tex2html4645"
  HREF="node224.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index.png"></A> <A NAME="tex2html2"
  HREF="http://nereida.deioc.ull.es/~plgrado/index.html"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="logoLPP.png"
 ALT="PL"></A><A NAME="tex2html3"
  HREF="http://campusvirtual.ull.es/1314/course/view.php?id=1104"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="PL moodle"></A><A NAME="tex2html4"
  HREF="http://campusvirtual.ull.es/1213m2/course/view.php?id=271"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="PL moodle"></A><A NAME="tex2html5"
  HREF="javascriptexamples.pdf"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="gv.jpeg"
 ALT="ps"></A><A NAME="tex2html6"
  HREF="http://crguezl.github.io/pl-html/"><IMG
  WIDTH="60" ALIGN="BOTTOM" BORDER="0"
 SRC="lupa.gif"
 ALT="ruby gems"></A><A NAME="tex2html7"
  HREF="https://developer.mozilla.org/es/docs/JavaScript"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="perlonion.jpeg"
 ALT="perldoc"></A><A NAME="tex2html8"
  HREF="http://github.com"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="google-code-project-hosting.jpeg"
 ALT="github"></A><A NAME="tex2html9"
  HREF="https://plus.google.com/u/0/communities/107031495100582318205"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="perl6.jpg"
 ALT="comunidad g+ PL1314"></A><A NAME="tex2html10"
  HREF="http://www.google.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ggoogle.gif"
 ALT="google"></A><A NAME="tex2html11"
  HREF="http://www.ull.es/view/centros/etsii/Grado/es"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="etsii.png"
 ALT="etsii"></A><A NAME="tex2html12"
  HREF="http://www.ull.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ull.gif"
 ALT="ull"></A><A NAME="tex2html13"
  HREF="https://github.com/crguezl"><IMG
  WIDTH="32" ALIGN="BOTTOM" BORDER="0"
 SRC="logopcgull.gif"
 ALT="crguezl at github"></A>
<BR>
<B> Sig:</B> <A NAME="tex2html4648"
  HREF="node116.html">Ejemplo de Middleware: Rack::ETag</A>
<B>Sup:</B> <A NAME="tex2html4642"
  HREF="node97.html">Rack, un Webserver Ruby</A>
<B> Ant:</B> <A NAME="tex2html4636"
  HREF="node114.html">Un Ejemplo Simple: Piedra,</A>
<B> Con:</B> 
<A NAME="tex2html4643"
  HREF="node221.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A>
<B> Ind:</B> 
<A NAME="tex2html4645"
  HREF="node224.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index.png"></A>
<BR> <P>
</DIV>
<!--End of Navigation Panel-->
<!--Table of Child-Links-->
<A NAME="CHILD_LINKS"><STRONG>Subsecciones</STRONG></A>

<UL CLASS="ChildLinks">
<LI><UL>
<LI><UL>
<LI><A NAME="tex2html4649"
  HREF="node115.html#SECTION061180010000000000000">Motivación para el método <TT>use</TT></A>
<LI><A NAME="tex2html4650"
  HREF="node115.html#SECTION061180020000000000000">La Clase Rack::Builder</A>
<LI><A NAME="tex2html4651"
  HREF="node115.html#SECTION061180030000000000000">Conversión de una Aplicación Rack a Rack::Builder</A>
<LI><A NAME="tex2html4652"
  HREF="node115.html#SECTION061180040000000000000">Ejemplo Simple de Uso de Rack::Builder</A>
<LI><A NAME="tex2html4653"
  HREF="node115.html#SECTION061180050000000000000">Ejemplo de Uso de Rack::Builder: Dos Middlewares</A>
</UL></UL></UL>
<!--End of Table of Child-Links-->
<HR>

<H1><A NAME="SECTION061180000000000000000"></A>
<A NAME="section:middleware"></A>
<BR>
Middleware y la Clase Rack::Builder
</H1>

<P>
We mentioned earlier that between the server and the framework, Rack
can be customized to your applications needs using middleware. 

<P>
The
fundamental idea behind Rack middleware is

<OL>
<LI>come between the
calling client and the server, 
</LI>
<LI>process the HTTP request before sending
it to the server, and 
</LI>
<LI>processing the HTTP response before returning it
to the client.
</LI>
</OL>

<P>

<H4><A NAME="SECTION061180010000000000000">
Motivación para el método <TT>use</TT></A>
</H4>
  

<P>
Si tenemos una app Rack <code>rack_app</code> 
y dos middlewares con nombres
<code>MiddleWare1</code>
y
<code>MiddleWare2</code> que queremos usar, podemos escribir esto:
<PRE>
Rack::Handler::Thin.run Middleware1.new(Middleware2.new(rack_app))
</PRE>
Si necesitamos pasar opciones en el segundo argumento la llamada quedaría
mas o menos como esto:
<PRE>
Rack::Handler::Thin.run(
  Middleware1.new(
    Middleware2.new(rack_app, options2),
    options1)
)
</PRE>
Si fueran mas de dos middlewares el correspondiente
código se volverá aún mas ilegible y hace mas fácil que metamos 
la pata cuando queramos hacer algo como  - por ejemplo -modificar 
el orden de los middleware.

<P>

<H4><A NAME="SECTION061180020000000000000">
La Clase Rack::Builder</A>
</H4>
  

<P>
La clase <A NAME="tex2html589"
  HREF="http://rack.rubyforge.org/doc/Rack/Builder.html">Rack::Builder</A> implementa un pequeño DSL para facilitar
la construcción de aplicaciones Rack.

<P>
<A NAME="tex2html590"
  HREF="http://rack.rubyforge.org/doc/Rack/Builder.html">Rack::Builder</A> is the thing that glues various Rack middlewares
and applications together and convert them into a single entity/rack
application. 

<P>
A good analogy is comparing <A NAME="tex2html591"
  HREF="http://rack.rubyforge.org/doc/Rack/Builder.html">Rack::Builder</A> 
object with a stack, where at the very bottom is your actual rack
application and all middlewares on top of it, and the whole stack
itself is a rack application too.

<P>

<OL>
<LI>El método <A NAME="tex2html592"
  HREF="http://rack.rubyforge.org/doc/Rack/Builder.html#method-i-use"><TT>use</TT> </A>
añade un middleware a la pila
</LI>
<LI>El método <A NAME="tex2html593"
  HREF="http://rack.rubyforge.org/doc/Rack/Builder.html#method-i-run"><TT>run</TT> </A>
ejecuta una aplicación
</LI>
<LI>El método <A NAME="tex2html594"
  HREF="http://rack.rubyforge.org/doc/Rack/Builder.html#method-i-map"><TT>map</TT> </A>
construye un <A NAME="tex2html595"
  HREF="http://rack.rubyforge.org/doc/Rack/URLMap.html">Rack::URLMap</A> en la forma apropiada.
It mounts a stack of rack application/middleware  on the specified path or URI.
</LI>
</OL>

<P>

<img src="rack_stack.png" />

<P>

<H4><A NAME="SECTION061180030000000000000">
Conversión de una Aplicación Rack a Rack::Builder</A>
</H4>
  

<P>
Dada la aplicación:

<P>
<PRE>
infinity = Proc.new {|env| [200, {"Content-Type" =&gt; "text/html"}, env.[inspect]] }
Rack::Handler::Mongrel.run infinity, :Port =&gt; 9292
</PRE>

<P>
Podemos reescribirla:

<P>
<PRE>
[~/sinatra/rack/rack-builder/map]$ cat app_builder.rb 
require 'rack'

infinity = Proc.new {|env| [200, {"Content-Type" =&gt; "text/html"}, [env.inspect]]}
builder = Rack::Builder.new
builder.run infinity
Rack::Handler::Thin.run builder, :Port =&gt; 9292
</PRE>
o bien:
<PRE>
[~/sinatra/rack/rack-builder/map]$ cat app_builder2.rb 
require 'rack'

infinity = Proc.new {|env| [200, {"Content-Type" =&gt; "text/html"}, [ env.inspect ]] }
builder = Rack::Builder.new do
  run infinity
end
Rack::Handler::Thin.run builder, :Port =&gt; 9292
</PRE>

<P>

<H4><A NAME="SECTION061180040000000000000">
Ejemplo Simple de Uso de Rack::Builder</A>
</H4>
  

<P>
<PRE>
[~/local/src/ruby/sinatra/rack/rack-builder/simple1]$ cat app.rb 
require 'rack'
require 'rack/server'

app = Rack::Builder.new do
  use Rack::CommonLogger
  use Rack::ShowExceptions
    use Rack::Lint
    map "/chuchu" do
      run lambda { |env| [ 200, {}, ["hello"]] }
    end
    map "/chachi" do
      run lambda { |env| [ 200, {}, ["world"]] }
    end
    run lambda { |env| [ 200, {}, ["everything"]] }
end

Rack::Server.start :app =&gt; app
</PRE>

<P>

<H4><A NAME="SECTION061180050000000000000">
Ejemplo de Uso de Rack::Builder: Dos Middlewares</A>
</H4>
  

<P>
<PRE>
[~/rack/rack-from-the-beginning(master)]$ cat hello_world.rb 
# hello_world.rb
require 'rack'
require 'rack/server'

class EnsureJsonResponse
  def initialize(app = nil)
    @app = app
  end

  # Set the 'Accept' header to 'application/json' no matter what.
  # Hopefully the next middleware respects the accept header :)
  def call(env)
    env['HTTP_ACCEPT'] = 'application/json'
    puts "env['HTTP_ACCEPT'] = #{env['HTTP_ACCEPT']}"
    @app.call(env) if @app
  end
end

class Timer
  def initialize(app = nil)
    @app = app
  end

  def call(env)
    before = Time.now
    status, headers, body = @app.call(env) if @app

    headers['X-Timing'] = (Time.now - before).to_i.to_s

    [status, headers, body]
  end
end

class HelloWorldApp

  def initialize(app = nil)
    @app = app
  end

  def self.call(env)
    [200, {}, ['hello world!']] 
  end
end

# put the timer at the top so it captures everything below it
app = Rack::Builder.new do 
  use Timer # put the timer at the top so it captures everything below it
  use EnsureJsonResponse
  run HelloWorldApp
end

Rack::Server.start :app =&gt; app
</PRE>

<P>
<PRE>
~/rack/rack-from-the-beginning(master)]$  cat Rakefile 
desc "run the server"
task :default do
  sh "rackup"
end

desc "run the server hello_world.rb"
task :server do
  sh "ruby hello_world.rb"
end

desc "run the client"
task :client do
  sh %q{curl -v 'http://localhost:9292'}
end

desc "run the client for hello_world"
task :client2 do
  sh %q{curl -v 'http://localhost:8080'}
end
</PRE>

<P>
<PRE>
[~/rack/rack-from-the-beginning(master)]$ rake server
ruby hello_world.rb
&gt;&gt; Thin web server (v1.5.1 codename Straight Razor)
&gt;&gt; Maximum connections set to 1024
&gt;&gt; Listening on 0.0.0.0:8080, CTRL+C to stop
</PRE>

<P>
<PRE>
[~/rack/rack-from-the-beginning(master)]$ rake client2
curl -v 'http://localhost:8080'
* About to connect() to localhost port 8080 (#0)
*   Trying ::1... Connection refused
*   Trying 127.0.0.1... connected
* Connected to localhost (127.0.0.1) port 8080 (#0)
&gt; GET / HTTP/1.1
&gt; User-Agent: curl/7.21.4 (universal-apple-darwin11.0) libcurl/7.21.4 OpenSSL/0.9.8y zlib/1.2.5
&gt; Host: localhost:8080
&gt; Accept: */*
&gt; 
&lt; HTTP/1.1 200 OK
&lt; X-Timing: 0
&lt; Connection: close
&lt; Server: thin 1.5.1 codename Straight Razor
&lt; 
* Closing connection #0
hello world!
</PRE>

<P>
<PRE>
[~/rack/rack-from-the-beginning(master)]$ rake server
ruby hello_world.rb
&gt;&gt; Thin web server (v1.5.1 codename Straight Razor)
&gt;&gt; Maximum connections set to 1024
&gt;&gt; Listening on 0.0.0.0:8080, CTRL+C to stop
env['HTTP_ACCEPT'] = application/json
</PRE>

<P>

<DIV CLASS="navigation"><HR>
<A NAME="tex2html4647"
  HREF="node116.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A> 
<A NAME="tex2html4641"
  HREF="node97.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A> 
<A NAME="tex2html4635"
  HREF="node114.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A> 
<A NAME="tex2html4643"
  HREF="node221.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A> 
<A NAME="tex2html4645"
  HREF="node224.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index.png"></A> <A NAME="tex2html2"
  HREF="http://nereida.deioc.ull.es/~plgrado/index.html"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="logoLPP.png"
 ALT="PL"></A><A NAME="tex2html3"
  HREF="http://campusvirtual.ull.es/1314/course/view.php?id=1104"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="PL moodle"></A><A NAME="tex2html4"
  HREF="http://campusvirtual.ull.es/1213m2/course/view.php?id=271"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="PL moodle"></A><A NAME="tex2html5"
  HREF="javascriptexamples.pdf"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="gv.jpeg"
 ALT="ps"></A><A NAME="tex2html6"
  HREF="http://crguezl.github.io/pl-html/"><IMG
  WIDTH="60" ALIGN="BOTTOM" BORDER="0"
 SRC="lupa.gif"
 ALT="ruby gems"></A><A NAME="tex2html7"
  HREF="https://developer.mozilla.org/es/docs/JavaScript"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="perlonion.jpeg"
 ALT="perldoc"></A><A NAME="tex2html8"
  HREF="http://github.com"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="google-code-project-hosting.jpeg"
 ALT="github"></A><A NAME="tex2html9"
  HREF="https://plus.google.com/u/0/communities/107031495100582318205"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="perl6.jpg"
 ALT="comunidad g+ PL1314"></A><A NAME="tex2html10"
  HREF="http://www.google.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ggoogle.gif"
 ALT="google"></A><A NAME="tex2html11"
  HREF="http://www.ull.es/view/centros/etsii/Grado/es"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="etsii.png"
 ALT="etsii"></A><A NAME="tex2html12"
  HREF="http://www.ull.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ull.gif"
 ALT="ull"></A><A NAME="tex2html13"
  HREF="https://github.com/crguezl"><IMG
  WIDTH="32" ALIGN="BOTTOM" BORDER="0"
 SRC="logopcgull.gif"
 ALT="crguezl at github"></A>
<BR>
<B> Sig:</B> <A NAME="tex2html4648"
  HREF="node116.html">Ejemplo de Middleware: Rack::ETag</A>
<B>Sup:</B> <A NAME="tex2html4642"
  HREF="node97.html">Rack, un Webserver Ruby</A>
<B> Ant:</B> <A NAME="tex2html4636"
  HREF="node114.html">Un Ejemplo Simple: Piedra,</A>
</DIV>
<!--End of Navigation Panel-->
<ADDRESS>
<I>Casiano Rodríguez León <BR>
2014-04-07</I>
</ADDRESS>
</BODY>
</HTML>
